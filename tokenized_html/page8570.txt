ldap users groups in virtualmin 32738 virtualmin fresh centos 6.5 minimal install fully updated then virtualmin installed via your script install.sh i have ldap users groups ldap client working inside of webmin perfectly even remote ssh with ldap users works then i try to create a server in virtualmin with the setting of store users and groups in ldap database set and get the dreaded error of creating administration group administration group was created but does not exist yet if i create groups in webmin module it works just fine i do n't have ncsd or any caching running that i know of where can i look for more error logs thoughts everything else works great submitted by jamiecameron on tue 03/18/2014 23:43 comment 1 that error means that the group was added to the ldap db but did n't show up as a unix group on the system does centos 6.5 perhaps introduce a delay between when an ldap entry is added and when it appears as a unix user or group submitted by marcusone on tue 03/18/2014 23:49 comment 2 it does n't even make it into the ldap db sorry forgot to add that detail so no dealy as it all works great in webmin modules where does virtualmin check for the group or where can i look for more error logs submitted by jamiecameron on tue 03/18/2014 23:52 comment 3 it might appear to be missing from ldap because if virtualmin adds the ldap entry checks if the group is visible and if not removes the entry so that the ldap db is n't full of partially created groups if you add a group in the webmin module is it immediately visible on the virtualmin system submitted by marcusone on wed 03/19/2014 00:22 comment 4 thanks but i 'm certain that it is n't in the ldap group is not visible anywhere so never got created i can create the same group name in webmin no problem which then causes virtualmin to fail saying the group already exists where in the code does it do the call to ldapadd or via the webmin module is there no debugging log for virtualmin/webmin edit if i force the group name to 'test an already existing group in ldap freshly created i get failed to create virtual server a unix group named test already exists try selecting a different administration username submitted by jamiecameron on wed 03/19/2014 19:04 comment 5 virtualmin and webmin add ldap users by connecting directly to the db and creating objects you might want to check the ldap server log to see what operations virtualmin is performing submitted by marcusone on wed 03/19/2014 20:46 comment 6 does virtualmin use webmin same module as all guides suggest you need webmin 's module to work and then virtualmin will just work webmin works virtualmin does n't there is obviously a bug in the virtualmin create server script the script deletes the group right after making it see the 'del command near the bottom of this snip submitted by jamiecameron on thu 03/20/2014 21:28 comment 7 that deletion is expected see the reason mentioned in comment 3 if you create a group at in the ldap users and groups module does the ldap server log the same add line submitted by marcusone on fri 03/21/2014 12:55 comment 8 what command does it use to check if the group is visible perhaps you can point out where in the code this add and check are done so that i can debug any 'timing issues or perhaps add a delay in the script to see if its an issue with some kind of cache or race condition only difference i see is the 'op=5 in the above and 'op=2 in the virtualmin one no idea what 'op is prior and post 'add there are searches done as expected submitted by jamiecameron on fri 03/21/2014 20:33 comment 9 i can send you an update to virtualmin that waits longer for the group to appear to hopefully fix the timing issue are you running the gpl or pro version of virtualmin submitted by marcusone on fri 03/21/2014 20:40 comment 10 gpl at the moment thanks submitted by marcusone on fri 03/21/2014 20:42 comment 11 can you let me know what file is modified/etc so that i can debug if that does n't work submitted by jamiecameron on sun 03/23/2014 00:52 comment 12 ok i 've emailed you an updated virtualmin gpl rpm package which adds a longer wait time for new ldap users and groups to show up submitted by marcusone on sun 03/23/2014 10:37 comment 13 thanks but getting the exact same error where are the log files for virtualmin what command are you using to check existence of groups because during your delay if i do a 'getent group webox on the machine console i get the correct response webox *:500 then i get an error about the user not found so whatever command you use now works if i issue the 'getent command in the pause but if i do n't do the 'getent group during the pause in your script i get the same error about group not found also the 'webox group was deleted yet virtualmin and 'getent group still think it exists so some kind of caching is happening in the sssd deamon submitted by marcusone on sun 03/23/2014 11:13 comment 14 during your pauses by spamming getent group grpname id usernamei got the script to continue so i need you to change what commands you use to check users or perhaps we can skip that check and just make sure they are added to ldap correctly and let the admin worry about them authenticating in the system now when it continues i get authentication errors in the email list add for virtual users in postfix aliases failed ldap add of maillocaladdress= webox webox.xx dc=virtual dc=refamco dc=ca failed modifications require authentication at ../web-lib-funcs.pl line 1381 mail for domain failed ldap add of maillocaladdress=webox.xx dc=virtual dc=xx dc=xxfailed modifications require authentication at ../web-lib-funcs.pl line 1381 yet adding a user works just fine once the server is created edit no adding a user works however no dc=virtual entry is created edit2 fixed my authentication issues but still does n't add virtual for newly created users submitted by jamiecameron on sun 03/23/2014 13:52 comment 15 ok this looks like progress .. maybe virtualmin does n't run any external command to check if a user exists instead it uses the getpwent and getgrent perl function calls for users and groups respectively i bet the problem is that they cache the user and group lists within the virtualmin miniserv.pl process and so do n't pick up the new ldap entries right away however other processes like getent will re-query the ldap server are you sure there is no nscd process running on your system submitted by marcusone on sun 03/23/2014 14:10 comment 16 yes i 'm sure no nscd not even installed and i played with the cache setting in sssd which actually made the issue worse as then when you delete the group it does n't reflect in getent or id for 5min so ca n't retry until the cache is expired anyway we can set virtualmin to make external calls so that the users/groups get into the same cache that the perl getpwent and getgrent are using as said virtualmin seems to pickup the change if a system call is made first right after the grp/user is made not sure why the perl module is n't doing the same thing likely a minor bug/way the perl module work submitted by marcusone on sun 03/23/2014 17:55 comment 17 found the issue yay its the sssd deamon caching results from ldap and the perl calls first problem is the perl calls to find users and groups does n't seem to trigger a lookup in the ldap directory so the user/group must be in the cache however the cache no matter what i set it to lasts for about 10sec or so in the testing i did setting all cache setting i could find in sssd.conf to 1 so the timing of getting the newly created into the cache is best done by doing this during your delay in the script rm -fr /var/lib/sss/db/* /etc/init.d/sssd restart getent group new group id new user i think if ldap is used the install script should just make and check ldap calls do n't check the system level for the user/group .that will solve 1 and make 2 not needed/matter submitted by jamiecameron on sun 03/23/2014 22:28 comment 18 i think what i 'll do is have virtualmin also try shelling out to getent to check if a new user or group exists that should get around whatever cache is in the perl process submitted by marcusone on tue 03/25/2014 19:42 comment 19 any progress on this or is it easy to disable the checks submitted by jamiecameron on wed 03/26/2014 19:37 comment 20 i 've implemented this and i can send you another beta version if you like submitted by marcusone on wed 03/26/2014 19:52 comment 21 sure submitted by jamiecameron on wed 03/26/2014 23:47 comment 22 ok i have emailed you an updated rpm submitted by marcusone on sun 03/30/2014 07:18 comment 23 unfortunately that has not solved the problem very strange i 'd much rather just have the option to remove the external check at this point submitted by utweb-systems on tue 04/01/2014 09:37 comment 24 we are also interested in this post so we are subscribing to follow the progress thanks -alex submitted by utweb-systems on fri 05/02/2014 12:14 comment 25 jamie we are also starting to encounter this issue with our instance shown in the screenshot below thanks -alex submitted by jamiecameron on fri 05/02/2014 14:09 comment 26 alex can you check that if a user is created in webmin 's ldap users and groups module that it shows up as a unix user on the system ie can it be switched to with the su command submitted by utweb-systems on fri 05/02/2014 14:22 comment 27 jamie yes that worked just fine it worked for the reseller account as well thanks -alex submitted by utweb-systems on fri 05/02/2014 14:23 comment 28 jamie however the delete did not submitted by jamiecameron on fri 05/02/2014 16:27 comment 29 that error with deletion is a separate un-related problem as for the first issue this may be due to a propagation delay between when a user is added to ldap and when it is visible to the unix system i can send you an update that should fix this which linux distro is virtualmin running on there submitted by marcusone on fri 05/02/2014 21:53 comment 30 there is no delay in adding to ldap and visibility on the linux system the issue is the delay in the visibility to the method employed by virtualmin to check the addition this issue has yet to be fixed submitted by jamiecameron on sat 05/03/2014 13:29 comment 31 actually virtualmin 4.07 which has been released to all users includes both a longer delay in checking for new users to show up and tries the getent command to find new users and groups rather than just relying on the getpwent function call in perl submitted by utweb-systems on mon 05/05/2014 11:38 comment 32 jamie we are running rhel 6.5 x64 thanks -alex submitted by jamiecameron on mon 05/05/2014 13:47 comment 33 alex when you create a domain is there a delay of around 10 seconds between the messages creating administration group and .. administration group was created but does not exist submitted by utweb-systems on mon 05/05/2014 13:54 comment 34 jamie no it is nearly immediate we are running the latest version of virtualmin pro as of thursday last week thanks -alex submitted by jamiecameron on mon 05/05/2014 19:11 comment 35 alex is there any chance i could remotely access this system to see what virtualmin it doing internally when it fails like this submitted by utweb-systems on tue 05/06/2014 09:10 comment 36 hello i 'm working with alex on this project and have done some additional testing this morning i am seeing the 10 second delay between creating administration group and .. administration group was created but does not exist parsing over the slapd logs i 'm not seeing an add line for the group anywhere i 'll see it iterate over every group in existence and then attempt to delete the administrative group it should have created as part of a cleanup process but no evidence that it ever tried to create the group in ldap in the first place if i do a watch -n1 getent group grep demo on the panel host the username i 'm creating has demo in it i do n't see it ever pop up during the creation process the last add notification i see is back on may 2nd before we updated to 4.07 -scotty via alex 's thread submitted by jamiecameron on tue 05/06/2014 20:05 comment 37 scotty if you go to webmin system ldap users and groups and create a group does that creation event show up in the ldap server 's log submitted by utweb-systems on wed 05/07/2014 08:45 comment 38 oddly i do n't see an add event for that however a group does indeed get created in ldap submitted by jamiecameron on wed 05/07/2014 16:09 comment 39 perhaps there is some additional logging that needs to be turned on i 'm very interested to know if the group is being created wrongly or just now visible from the virtualmin system submitted by utweb-systems on thu 05/08/2014 11:49 comment 40 all we were able to demonstrate success on this it turns out there was a misconfiguration on the group key in the sssd configuration that was causing our issue now we are able to successfully create virtual servers in virtualmin with the account information stored in our ldap service thanks for all the help thanks -alex submitted by jamiecameron on thu 05/08/2014 12:58 comment 41 great submitted by issues on thu 05/22/2014 13:01 comment 42 automatically closed issue fixed for 2 weeks with no activity