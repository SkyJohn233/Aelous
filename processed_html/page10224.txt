Mail Server/Exim/Postfix   Mellowhost Blog Mellowhost Blog Web Hosting Journal To configure postfix to relay mail using another MTA, you may do the following steps: postconf -e 'relayhost = smtp.to.relay.com' postconf -e 'smtp_sasl_auth_enable = yes' postconf -e 'smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd' postconf -e 'smtp_sasl_security_options=' Replace  smtp.to.relay.com  with the original MTA hostname that you going to use for relaying. Now, create the  sasl_passwd  file in  /etc/postfix  with the following inside: smtp.to.relay.com   smtp_username:smtp_password Now, use postmap to generate postfix hash db: postmap /etc/postfix/sasl_passwd You can verify if it s working with the following: postmap -q smtp.to.relay.com /etc/postfix/sasl_passwd This will return the username and password for your smtp relay host. Now all you need to do is to restart the postfix service postfix restart Exim provides a quick way to check the total number of mails in the queue. This is done using the  exim -bpc  Although, this is not the same for postfix. Postfix doesn t come with an easy way to do that. A quick tip on what I use to check the postfix queue number is the following command: # mailq | tail -n 1 -- 6899 Kbytes in 1518 Requests. Basically, postfix returns the queue statistics at the end of the queue listing command. We are simply tailing that to find the number. Postfix queue can be cleared using the postsuper command. The syntax is as following: # postsuper -d ALL It will clear all the postfix queue. You can specifically clear the deferred emails for example from the postfix queue as following: # postsuper -d ALL deferred If you have a large quantity in postfix queue, there is actually a quicker and easier way to do that. You can simply remove all the folders under /var/spool/postfix and it will clear the queue. # rm -Rf /var/spool/postfix/* # mailq | tail -n 1 Mail queue is empty Note: The folders inside postfix would get created automatically once the queue starts filling up, nothing to worry about. Exim queue can be checked using the following: # exim -bp To check the number of mails in queue, you can use: # exim -bpc To remove a message from exim queue, you need to use the following: # exim -Mrm {message-id} There is no build in command to clear all the mails from exim queue. You can use a pipe command to clear the exim queue as following: # exim -bp | exiqgrep -i | xargs exim -Mrm Although, there are even quicker and easier way to clear the exim queue, specially if you have a lot of emails in queue and the server is pretty loaded. # rm -Rf /var/spool/exim/input Removing the input directory should clear the exim queue. Note: The directory would automatically create once the exim starts it s queue again, no need to worry. One of my customer came with an error saying the postfix in his server isn t working. The server was running CentOS 7, and the system postfix status was inactive, means not running. Although, the system queue was running I could see. The error that was returning while restarting/checking status was the following: # service postfix status Redirecting to /bin/systemctl status postfix.service ● postfix.service - Postfix Mail Transport Agent Loaded: loaded (/usr/lib/systemd/system/postfix.service; enabled; vendor preset: disabled) Active: failed (Result: exit-code) since Tue 2018-01-09 04:04:05 UTC; 1s ago Process: 9201 ExecStart=/usr/sbin/postfix start (code=exited, status=1/FAILURE) Process: 9197 ExecStartPre=/usr/libexec/postfix/chroot-update (code=exited, status=0/SUCCESS) Process: 9194 ExecStartPre=/usr/libexec/postfix/aliasesdb (code=exited, status=0/SUCCESS) Main PID: 1358 (code=killed, signal=TERM) Jan 09 04:04:03 twin7.hifrank.biz systemd[1]: Starting Postfix Mail Transport Agent... Jan 09 04:04:03 twin7.hifrank.biz postfix/master[9273]: fatal: open lock file /var/lib/postfix/master.lock: unable to set exclusive lock: Resource tempo...vailable Jan 09 04:04:04 twin7.hifrank.biz postfix/master[9272]: fatal: daemon initialization failure Jan 09 04:04:05 twin7.hifrank.biz postfix/postfix-script[9274]: fatal: mail system startup failed Jan 09 04:04:05 twin7.hifrank.biz systemd[1]: postfix.service: control process exited, code=exited status=1 Jan 09 04:04:05 twin7.hifrank.biz systemd[1]: Failed to start Postfix Mail Transport Agent. Jan 09 04:04:05 twin7.hifrank.biz systemd[1]: Unit postfix.service entered failed state. Jan 09 04:04:05 twin7.hifrank.biz systemd[1]: postfix.service failed. The error to note here is the following: fatal: open lock file /var/lib/postfix/master.lock I first killed the smtp and smtpd processes that runs by postfix: # killall -9 smtp # killall -9 smtpd But that didn t solve the problem. I then used the fuser command to check which process holds the lock file: # fuser /var/lib/postfix/master.lock /var/lib/postfix/master.lock: 18698 Then we check the process 18698 and kill the responsible process: # ps -axwww|grep 18698 9333 pts/0 S+ 0:00 grep --color=auto 18698 18698 ? Ss 4:28 /usr/libexec/postfix/master -w # killall -9 /usr/libexec/postfix/master or # kill -9 18698 Once the process is killed, you can now start the postfix: # service postfix start # service postfix status|grep Active Redirecting to /bin/systemctl status postfix.service Active: active (running) since Tue 2018-01-09 04:15:50 UTC; 4min 45s ago We had a customer complaining about a commonly seen error of the following type: 550 Please turn on SMTP Authentication in your mail client. mail-pf0-f172.google.com [209.85.192.172]:38632 is not permitted to relay through this server without authentication. Diagnostic-Code: smtp; 550-Please turn on SMTP Authentication in your mail client. 550-mail-pf0-f172.google.com [209.85.192.172]:38632 is not permitted to relay 550 through this server without authentication. reason: 550-Please turn on SMTP Authentication in your mail client. 550-mout.kundenserver.de [212.227.17.24]:49392 is not permitted to relay 550 through this server without authentication. They were all basically the same error. This is a common error and the solution is pretty simple as it looks like. Enabling  SMTP Authentication  on the outlook or the mail client should solve the problem. But interestingly, the client was smart and he wasn t doing any mistake with  SMTP authentication . The error was actually showing up when someone was trying to send the mail to him (As a receiver SMTP). We then tried digging the error further. There is something we need to remember. SMTP is not only authenticated using username and password, it also goes through a dns authentication check too. If your dkim/domainkeys/spf/dmarc do not match as the mail server has advised, the mail will get denied with the same type of error (Error code 550). We then realized the customer account was transfered earlier from a different server and the old domainkeys were still there in it s DNS zone file. As domainkeys are RSA keys generated per server, it is important to regenerate the keys after the server change. Otherwise, the old key check through the DNS can trigger the 550 error from the receiver relay. We had deleted and generated a new domainkeys for the customer and the error went off. 