mail server/exim/postfix mellowhost blog mellowhost blog web hosting journal to configure postfix to relay mail using another mta you may do the following steps postconf -e 'relayhost smtp.to.relay.com postconf -e 'smtp_sasl_auth_enable yes postconf -e 'smtp_sasl_password_maps hash /etc/postfix/sasl_passwd postconf -e 'smtp_sasl_security_options= replace smtp.to.relay.com with the original mta hostname that you going to use for relaying now create the sasl_passwd file in /etc/postfix with the following inside smtp.to.relay.com smtp_username smtp_password now use postmap to generate postfix hash db postmap /etc/postfix/sasl_passwd you can verify if it s working with the following postmap -q smtp.to.relay.com /etc/postfix/sasl_passwd this will return the username and password for your smtp relay host now all you need to do is to restart the postfix service postfix restart exim provides a quick way to check the total number of mails in the queue this is done using the exim -bpc although this is not the same for postfix postfix doesn t come with an easy way to do that a quick tip on what i use to check the postfix queue number is the following command mailq tail -n 1 6899 kbytes in 1518 requests basically postfix returns the queue statistics at the end of the queue listing command we are simply tailing that to find the number postfix queue can be cleared using the postsuper command the syntax is as following postsuper -d all it will clear all the postfix queue you can specifically clear the deferred emails for example from the postfix queue as following postsuper -d all deferred if you have a large quantity in postfix queue there is actually a quicker and easier way to do that you can simply remove all the folders under /var/spool/postfix and it will clear the queue rm -rf /var/spool/postfix/* mailq tail -n 1 mail queue is empty note the folders inside postfix would get created automatically once the queue starts filling up nothing to worry about exim queue can be checked using the following exim -bp to check the number of mails in queue you can use exim -bpc to remove a message from exim queue you need to use the following exim -mrm message-id there is no build in command to clear all the mails from exim queue you can use a pipe command to clear the exim queue as following exim -bp exiqgrep -i xargs exim -mrm although there are even quicker and easier way to clear the exim queue specially if you have a lot of emails in queue and the server is pretty loaded rm -rf /var/spool/exim/input removing the input directory should clear the exim queue note the directory would automatically create once the exim starts it s queue again no need to worry one of my customer came with an error saying the postfix in his server isn t working the server was running centos 7 and the system postfix status was inactive means not running although the system queue was running i could see the error that was returning while restarting/checking status was the following service postfix status redirecting to /bin/systemctl status postfix.service ‚óè postfix.service postfix mail transport agent loaded loaded /usr/lib/systemd/system/postfix.service enabled vendor preset disabled active failed result exit-code since tue 2018-01-09 04:04:05 utc 1s ago process 9201 execstart=/usr/sbin/postfix start code=exited status=1/failure process 9197 execstartpre=/usr/libexec/postfix/chroot-update code=exited status=0/success process 9194 execstartpre=/usr/libexec/postfix/aliasesdb code=exited status=0/success main pid 1358 code=killed signal=term jan 09 04:04:03 twin7.hifrank.biz systemd 1 starting postfix mail transport agent jan 09 04:04:03 twin7.hifrank.biz postfix/master 9273 fatal open lock file /var/lib/postfix/master.lock unable to set exclusive lock resource tempo vailable jan 09 04:04:04 twin7.hifrank.biz postfix/master 9272 fatal daemon initialization failure jan 09 04:04:05 twin7.hifrank.biz postfix/postfix-script 9274 fatal mail system startup failed jan 09 04:04:05 twin7.hifrank.biz systemd 1 postfix.service control process exited code=exited status=1 jan 09 04:04:05 twin7.hifrank.biz systemd 1 failed to start postfix mail transport agent jan 09 04:04:05 twin7.hifrank.biz systemd 1 unit postfix.service entered failed state jan 09 04:04:05 twin7.hifrank.biz systemd 1 postfix.service failed the error to note here is the following fatal open lock file /var/lib/postfix/master.lock i first killed the smtp and smtpd processes that runs by postfix killall -9 smtp killall -9 smtpd but that didn t solve the problem i then used the fuser command to check which process holds the lock file fuser /var/lib/postfix/master.lock /var/lib/postfix/master.lock 18698 then we check the process 18698 and kill the responsible process ps -axwww|grep 18698 9333 pts/0 s+ 0:00 grep color=auto 18698 18698 ss 4:28 /usr/libexec/postfix/master -w killall -9 /usr/libexec/postfix/master or kill -9 18698 once the process is killed you can now start the postfix service postfix start service postfix status|grep active redirecting to /bin/systemctl status postfix.service active active running since tue 2018-01-09 04:15:50 utc 4min 45s ago we had a customer complaining about a commonly seen error of the following type 550 please turn on smtp authentication in your mail client mail-pf0-f172.google.com 209.85.192.172 :38632 is not permitted to relay through this server without authentication diagnostic-code smtp 550-please turn on smtp authentication in your mail client 550-mail-pf0-f172.google.com 209.85.192.172 :38632 is not permitted to relay 550 through this server without authentication reason 550-please turn on smtp authentication in your mail client 550-mout.kundenserver.de 212.227.17.24 :49392 is not permitted to relay 550 through this server without authentication they were all basically the same error this is a common error and the solution is pretty simple as it looks like enabling smtp authentication on the outlook or the mail client should solve the problem but interestingly the client was smart and he wasn t doing any mistake with smtp authentication the error was actually showing up when someone was trying to send the mail to him as a receiver smtp we then tried digging the error further there is something we need to remember smtp is not only authenticated using username and password it also goes through a dns authentication check too if your dkim/domainkeys/spf/dmarc do not match as the mail server has advised the mail will get denied with the same type of error error code 550 we then realized the customer account was transfered earlier from a different server and the old domainkeys were still there in it s dns zone file as domainkeys are rsa keys generated per server it is important to regenerate the keys after the server change otherwise the old key check through the dns can trigger the 550 error from the receiver relay we had deleted and generated a new domainkeys for the customer and the error went off